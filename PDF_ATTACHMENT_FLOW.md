# PDF Attachment Flow Documentation

## Overview
This document describes how PDF files generated by the `print_to_pdf` tool are handled and passed to callback receivers via LlamaCloud file references.

## Architecture

### Key Principle
PDF files are **NOT** passed as base64-encoded content in the callback. Instead, they are:
1. Uploaded to LlamaCloud
2. Referenced by `file_id` in callback attachments
3. Downloaded by the callback receiver using the `file_id`

This approach avoids HTTP request size limits and follows the LlamaCloud integration pattern.

## Complete Flow

### 1. PDF Generation (PrintToPDFTool)
**Location:** `src/basic/tools.py` (lines 872-932)

```python
async def execute(self, **kwargs) -> dict[str, Any]:
    # Create PDF in memory using ReportLab
    pdf_bytes = pdf_buffer.getvalue()
    
    # Upload to LlamaCloud
    file_id = await upload_file_to_llamacloud(pdf_bytes, filename)
    
    # Return file_id in result
    return {"success": True, "file_id": file_id}
```

**Output:** Returns `{"success": True, "file_id": "some-uuid"}`

### 2. Workflow Execution
**Location:** `src/basic/email_workflow.py` (execute_plan step)

The workflow executes the print_to_pdf tool and stores the result, including the `file_id`, in the results list:

```python
results.append({
    "step": i + 1,
    "tool": tool_name,
    "description": description,
    **result,  # Includes file_id from PrintToPDFTool
})
```

### 3. Execution Log Creation
**Location:** `src/basic/email_workflow.py` (lines 942-1023)

The execution log (execution_log.md) includes the file_id for transparency:

```python
if "file_id" in result:
    output += f"**Generated File ID:** `{result['file_id']}`\n\n"
```

**Example output in execution_log.md:**
```markdown
## Step 2: print_to_pdf

**Description:** Convert text to PDF
**Status:** ✓ Success
**Generated File ID:** `550e8400-e29b-41d4-a716-446655440000`
```

This allows users to see which files were generated and their LlamaCloud IDs.

### 4. Attachment Collection
**Location:** `src/basic/email_workflow.py` (lines 1025-1075)

```python
def _collect_attachments(self, results: list[dict]) -> list[Attachment]:
    for result in results:
        if not result.get("success", False):
            continue
        
        file_id = result.get("file_id")
        if file_id:
            # Create attachment with file_id (NO content)
            attachment = Attachment(
                id=f"generated-{step_num}",
                name=f"output_step_{step_num}.pdf",
                type="application/pdf",
                file_id=file_id,  # LlamaCloud reference
            )
            attachments.append(attachment)
```

**Key points:**
- Only successful steps are processed
- Only results with `file_id` are collected
- Attachments contain `file_id` but NOT `content`
- For print_to_pdf, filename is `output_step_{N}.pdf`

### 5. Callback Preparation
**Location:** `src/basic/email_workflow.py` (lines 770-800)

```python
# Collect file attachments (with file_id)
attachments = self._collect_attachments(results)

# Add execution log (with base64 content, since it's small)
execution_log_attachment = Attachment(
    id="execution-log",
    name="execution_log.md",
    type="text/markdown",
    content=execution_log_b64,  # Small file, uses content
)
attachments.append(execution_log_attachment)

# Create callback request
response_email = SendEmailRequest(
    to_email=email_data.from_email,
    subject=f"Re: {email_data.subject}",
    text=result_text,
    attachments=attachments,  # Mix of file_id and content attachments
)
```

### 6. Callback JSON Structure
**Location:** `src/basic/email_workflow.py` (lines 737-747)

The callback is sent as JSON via HTTP POST:

```python
response = await client.post(
    callback_url,
    json=email_request.model_dump(),
    headers={"Content-Type": "application/json", "X-Auth-Token": auth_token},
)
```

**Example JSON sent to callback:**
```json
{
  "to_email": "user@example.com",
  "subject": "Re: Convert document to PDF",
  "text": "Your PDF has been generated...",
  "attachments": [
    {
      "id": "generated-2",
      "name": "output_step_2.pdf",
      "type": "application/pdf",
      "file_id": "550e8400-e29b-41d4-a716-446655440000",
      "content": null
    },
    {
      "id": "execution-log",
      "name": "execution_log.md",
      "type": "text/markdown",
      "file_id": null,
      "content": "IyBXb3JrZmxvdyBFeGVjdXRpb24gTG9n..."
    }
  ]
}
```

## Callback Receiver Requirements

To handle PDF attachments, the callback receiver must:

1. **Check attachment mode:**
   ```python
   if attachment.file_id:
       # Download from LlamaCloud
       pdf_bytes = await download_file_from_llamacloud(attachment.file_id)
   elif attachment.content:
       # Decode base64 content
       pdf_bytes = base64.b64decode(attachment.content)
   ```

2. **Have access to LlamaCloud:**
   - Must have `LLAMA_CLOUD_API_KEY` environment variable
   - Must have `LLAMA_CLOUD_PROJECT_ID` environment variable
   - Must have permission to access files in the same project

3. **Use the download utility:**
   ```python
   from basic.utils import download_file_from_llamacloud
   
   file_bytes = await download_file_from_llamacloud(file_id)
   ```

## Logging

Comprehensive logging is available to trace the flow:

```
INFO: [COLLECT ATTACHMENTS] Processing 3 result(s)
INFO: [COLLECT ATTACHMENTS] Found file_id '550e8400-...' from tool 'print_to_pdf' (step 2)
INFO: Adding attachment: output_step_2.pdf (file_id: 550e8400-...)
INFO: [COLLECT ATTACHMENTS] Returning 1 attachment(s)
INFO: [COLLECT ATTACHMENTS] Collected 1 file attachment(s) from results
INFO:   - output_step_2.pdf (file_id: 550e8400-..., content: None)
INFO: [ATTACHMENTS FINAL] Total 2 attachment(s) will be sent in callback
INFO: [SEND RESULTS CALLBACK] Sending results email to user@example.com
```

## Troubleshooting

### PDF not appearing in callback
1. Check logs for `[COLLECT ATTACHMENTS] Found file_id` - if missing, print_to_pdf didn't generate file_id
2. Check logs for `Adding attachment` - if missing, attachment wasn't created
3. Check callback JSON - verify `file_id` field is present and not null

### Callback receiver can't access file
1. Verify callback receiver has `LLAMA_CLOUD_API_KEY` set
2. Verify callback receiver has `LLAMA_CLOUD_PROJECT_ID` set to same project
3. Check LlamaCloud permissions - receiver must have access to the project
4. Verify file exists: try downloading manually with the file_id

### File_id is null in callback
1. Check print_to_pdf result - did upload succeed?
2. Check for error logs from `upload_file_to_llamacloud`
3. Verify `LLAMA_CLOUD_API_KEY` and `LLAMA_CLOUD_PROJECT_ID` are set in workflow environment

## Key Differences: execution_log.md vs PDFs

| Aspect | execution_log.md | PDFs from print_to_pdf |
|--------|------------------|------------------------|
| **Size** | Small (few KB) | Potentially large (MB) |
| **Storage** | Inline as base64 `content` | LlamaCloud via `file_id` |
| **Reason** | Avoids HTTP size limits | Avoids HTTP size limits |
| **Access** | Directly from JSON | Requires LlamaCloud download |

## Related Files

- `src/basic/tools.py` - PrintToPDFTool implementation
- `src/basic/email_workflow.py` - Workflow execution and attachment handling
- `src/basic/utils.py` - LlamaCloud upload/download utilities
- `src/basic/models.py` - Attachment model definition
- `LLAMACLOUD_FILES.md` - General LlamaCloud integration documentation

## Summary

The PDF attachment flow ensures that:
1. ✅ PDFs are uploaded to LlamaCloud, not included as base64
2. ✅ `file_id` references are passed in callback JSON
3. ✅ File IDs are documented in execution_log.md for transparency
4. ✅ HTTP request size limits are avoided
5. ✅ Callback receivers can download files using provided file_id
