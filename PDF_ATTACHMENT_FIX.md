# Fix: PDF Attachments in Callback

## Issue
PDF files generated by `print_to_pdf` tool were being referenced in the email body text but the actual PDF attachment was not being properly passed to the callback receiver with both `file_id` and `content` fields populated.

## Root Cause
While the `_collect_attachments` method was correctly creating Attachment objects with `file_id`, it was not downloading the actual file content from LlamaCloud and including it as base64-encoded `content`. This created compatibility issues with callback receivers that might not support the file_id-based LlamaCloud integration and expect the traditional base64 content field.

## Solution
Modified `_collect_attachments` to download files from LlamaCloud and include both `file_id` and `content` fields in attachments:

1. **Download from LlamaCloud**: When a file_id is found in results, download the actual file bytes
2. **Base64 Encode**: Encode the downloaded content as base64
3. **Include Both Fields**: Create Attachment with both file_id (for LlamaCloud-aware receivers) and content (for traditional receivers)
4. **Graceful Fallback**: If download fails, still create attachment with file_id only and log a warning

## Changes Made

### 1. Updated `_collect_attachments` Method
**File**: `src/basic/email_workflow.py`

- Changed from synchronous to async method to support file downloads
- Added call to `download_file_from_llamacloud()` for each file_id
- Base64 encodes downloaded content
- Includes both `file_id` and `content` in Attachment objects
- Handles download failures gracefully with fallback to file_id-only mode

### 2. Updated Import Statement
**File**: `src/basic/email_workflow.py`

Added `download_file_from_llamacloud` to imports from `utils`.

### 3. Updated Attachment Model Documentation
**File**: `src/basic/models.py`

Updated docstring to clarify that Attachment supports three modes:
1. Base64 content mode
2. LlamaCloud file mode  
3. **Hybrid mode** (NEW): Both content and file_id for maximum compatibility

### 4. Updated Tests
**Files**: 
- `tests/test_workflow_execution_fixes.py` - Updated existing tests to await async `_collect_attachments`
- `tests/test_print_to_pdf_attachment_fix.py` - Added comprehensive new tests

## Benefits

1. **Maximum Compatibility**: Callback receivers can use either field based on their capabilities
2. **Backward Compatible**: Existing receivers expecting content still work
3. **Forward Compatible**: New receivers can use file_id for efficient LlamaCloud integration
4. **Graceful Degradation**: If download fails, attachment still includes file_id
5. **No Breaking Changes**: Attachment model still validates that at least one field is present

## Test Coverage

Added four comprehensive tests:
1. `test_collect_attachments_includes_content_and_file_id` - Verifies both fields are populated
2. `test_collect_attachments_handles_download_failure_gracefully` - Ensures robustness
3. `test_callback_includes_both_fields` - End-to-end validation
4. `test_multiple_pdf_attachments` - Multiple PDFs handled correctly

All existing tests updated and passing.

## Example

Before fix:
```json
{
  "attachments": [
    {
      "id": "generated-1",
      "name": "output_step_1.pdf",
      "type": "application/pdf",
      "content": null,
      "file_id": "abc-123-xyz"
    }
  ]
}
```

After fix:
```json
{
  "attachments": [
    {
      "id": "generated-1",
      "name": "output_step_1.pdf",
      "type": "application/pdf",
      "content": "JVBERi0xLjQKJeLjz9MKMyAwIG9...",  // Base64 PDF content
      "file_id": "abc-123-xyz"
    }
  ]
}
```

Now callback receivers can choose to either:
- Use `content` directly (traditional approach)
- Use `file_id` to download from LlamaCloud (efficient approach)
- Have both available for flexibility

## Performance Considerations

- Downloads are done asynchronously during result collection
- Download failures don't block the workflow
- For large PDFs, the base64 content adds ~33% size overhead to the callback JSON
- The trade-off ensures maximum compatibility and reliability

## Logging

The fix adds detailed logging:
- `"Downloading file {file_id} from LlamaCloud for attachment"`
- `"Successfully downloaded {bytes} bytes for {filename}"`
- `"Failed to download file {file_id}: {error}. Creating attachment with file_id only."`
- `"Adding attachment: {filename} (file_id: {file_id}, content: present/not available)"`
