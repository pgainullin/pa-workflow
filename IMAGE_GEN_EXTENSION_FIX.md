# Image Gen Tool File Extension Fix - Summary

## Issue
The Image Gen Tool was saving output files with the wrong extension (`.dat` instead of `.png`), and filenames were not intuitive based on the prompt.

## Root Cause
In `src/basic/response_utils.py`, the `collect_attachments()` function had a fallback case that assigned `.dat` extension and `application/octet-stream` MIME type to all tools except `print_to_pdf`. This meant that files generated by the `image_gen` tool were being saved with the wrong extension.

## Solution

### 1. Added `sanitize_filename_from_prompt()` helper function
Created a new helper function that:
- Converts prompts to safe, lowercase filenames
- Removes special characters
- Replaces spaces with underscores
- Truncates to a maximum length (default 50 characters)
- Handles empty/invalid prompts with a default fallback

### 2. Updated `collect_attachments()` function
Added specific handling for the `image_gen` tool:
- Uses `.png` extension
- Uses `image/png` MIME type
- Creates intuitive filenames from the prompt when available
- Falls back to `generated_image_step_N.png` when prompt is missing
- **NEW:** Handles multiple images via `file_ids` array with indexed filenames

### 3. Changes Made

**File: `src/basic/response_utils.py`**
- Added `sanitize_filename_from_prompt()` function (lines 35-60)
- Updated `collect_attachments()` to handle `image_gen` tool for single images (lines 350-358)
- Added support for multiple images via `file_ids` array (lines 370-395)

**File: `tests/test_workflow_execution_fixes.py`**
- Added 5 unit tests for `sanitize_filename_from_prompt()` function
- Added 6 integration tests for `collect_attachments()` with image_gen tool (including multiple images)
- Fixed 2 existing tests that had unnecessary mock patches

## Test Results

All new tests pass:
- ✅ `test_sanitize_filename_from_prompt_basic`
- ✅ `test_sanitize_filename_from_prompt_special_chars`
- ✅ `test_sanitize_filename_from_prompt_truncation`
- ✅ `test_sanitize_filename_from_prompt_empty`
- ✅ `test_sanitize_filename_from_prompt_trailing_underscores`
- ✅ `test_collect_attachments_image_gen_with_prompt`
- ✅ `test_collect_attachments_image_gen_without_prompt`
- ✅ `test_collect_attachments_image_gen_long_prompt`
- ✅ `test_collect_attachments_image_gen_special_characters`
- ✅ `test_collect_attachments_image_gen_multiple_images_with_prompt`
- ✅ `test_collect_attachments_image_gen_multiple_images_without_prompt`

Existing tests still pass:
- ✅ `test_collect_attachments_from_results`
- ✅ `test_collect_attachments_skips_failed_steps`

## Example Behavior

### Before Fix
```python
# Image gen with prompt "A beautiful sunset"
filename: "generated_file_step_1.dat"
mime_type: "application/octet-stream"
```

### After Fix
```python
# Single image with prompt
filename: "a_beautiful_sunset_step_1.png"
mime_type: "image/png"

# Single image without prompt
filename: "generated_image_step_1.png"
mime_type: "image/png"

# Multiple images with prompt (NEW)
filenames: ["a_kitten_step_2_1.png", "a_kitten_step_2_2.png", "a_kitten_step_2_3.png"]
mime_type: "image/png"

# Multiple images without prompt (NEW)
filenames: ["generated_image_step_3_1.png", "generated_image_step_3_2.png"]
mime_type: "image/png"
```

## Backwards Compatibility
- The fix maintains backwards compatibility for other tools
- `print_to_pdf` tool continues to work as before
- All other unrecognized tools still get `.dat` extension as fallback
- No changes to the Image Gen Tool API or return values

## Files Changed
1. `src/basic/response_utils.py` - Core fix implementation
2. `tests/test_workflow_execution_fixes.py` - Comprehensive test coverage
